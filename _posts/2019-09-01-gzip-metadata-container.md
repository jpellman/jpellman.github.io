---
layout: post
title: "On Use of the Gzip Header to Store Metadata"
date:   2018-09-01 23:48:32
comments: true
permalink: /gzip-metadata.html
---

I haven't made a blog post in a while, and since it's a long weekend I figured it might be a good time to express some thoughts I've been having about one particular approach to handling metadata for arbitary file formats.  In the distant past, I was heavily involved in a community that was developing a standard for enriching neuroimaging datasets with metadata.  I'm not going to re-hash all of the advantages that creating such a standard confers upon the neuroscience community, since others have done so extensively elsewhere, but the short of it is that the standard, the Brain Imaging Data Structure (BIDS), has done much to increase both the discoverability and reusability of fMRI/EEG/MEG datasets that otherwise would have remained "hidden" in a proverbial file drawer somewhere.  If you're interested in understanding BIDS more, there is a [paper](https://doi.org/10.1101/034561) that goes into more detail.  For this post, I'm going to focus on one particular technical choice that was made about how metadata fields are encoded in BIDS.

In fMRI data analysis, the two most heavily used formats are NIfTI (described in great detail [here](https://brainder.org/2012/09/23/the-nifti-file-format/) and [here](https://brainder.org/2015/04/03/the-nifti-2-file-format/) and MINC.  In terms of format adoption, the majority of tools available to neuroscientists favor NIfTI support, which led the designers of BIDS to focus on finding ways to inject additional metadata into this format.  The NIfTI file header already contains quite a few fields for neuroscience-specific metadata, but adding additional metadata fields to this header requires that a working group convene, engage in debate, and that some degree of backwards compatibility is maintained so that existing neuroimaging tools don't break.  This change control process, while ensuring technical stability, also makes it difficult for researchers and tool developers to rapidly experiment with additional metadata fields and iterate upon how those fields affect data sharing and reusability.

The BIDS developers wanted to have that ability to enrich NIfTI files with new metadata fields while not breaking existing tools.  The technical solution that the they arrived at was to use a JSON-formatted sidecar file, wherein a file with the same name as a NIfTI file but a different extension would contain various metadata entries as key-value pairs.  Such sidecar files are a fairly common way to enrich rigidly-defined file formats with additional metadata, and are readily seen elsewhere in the wild.  For instance, sidecar files are used by [gmvault](http://gmvault.org/) to store metadata that is feature-specific to Gmail / not part of an official e-mail message format standard and by [Kodi](https://kodi.tv/) to store video metadata (see [here](https://kodi.wiki/view/NFO_files)).  In the case of BIDS, a long-term goal was to engage the  NIfTI working group so that this JSON file could itself be embedded within the NIfTI file header in a future version of the NIfTI format:

> Storing metadata in JSON files has advantages of accessibility, but can be error prone because data and metadata do not live in the same file. In future revisions of BIDS we will explore the possibility of storing metadata as a JSON text extension of the NIfTI header.

Also all metadata should be embedded.  The reason NIfTI was made in the first place was because sidecar formats were a huge headache.

As near as I can tell, this never happened.  However, there's an interesting workaround.  Most NIfTI data is commonly gzipped, and most tools seamlessly decompress NIfTI data with zlib when reading it in.  That is to say, that one very rarely encounters the ".nii" file format extension used by NIfTI alone- it is almost always written ".nii.gz" because the data is almost always compressed.
